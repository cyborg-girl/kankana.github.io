<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Context-Aware QA Agent — Context Engineering Demo</title>

<!-- Particles -->
<script src="https://cdn.jsdelivr.net/npm/particles.js@2.0.0/particles.min.js"></script>

<!-- Cvless-ish Dark Theme -->
<style>
  :root{
    --bg:#0d1117; --panel:#161b22; --border:#30363d;
    --text:#e6edf3; --muted:#a9b2be; --accent:#58a6ff; --accent-2:#1f6feb;
    --ok:#2ea043; --warn:#f0883e; --danger:#f85149;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0; background:var(--bg); color:var(--text);
    font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Inter, "Helvetica Neue", Arial, "Apple Color Emoji","Segoe UI Emoji";
    overflow-x:hidden;
  }
  #particles-js{position:fixed; inset:0; z-index:-1}

  .wrap{max-width:1200px; margin:64px auto; padding:0 20px}
  h1{margin:0 0 8px; text-align:center; font-weight:800; letter-spacing:.2px}
  .subtitle{
    text-align:center; color:var(--muted); margin:6px auto 22px; max-width:820px;
  }

  /* Step-by-step explainer */
  .steps{
    margin:18px auto 28px; max-width:920px; display:grid; gap:10px;
    grid-template-columns: repeat(4,1fr);
  }
  .step{
    background:rgba(22,27,34,.9); border:1px solid var(--border); border-radius:14px;
    padding:12px; text-align:center; font-size:.95rem; color:var(--muted);
  }
  .step b{color:var(--text)}
  .step.active{outline:2px solid var(--accent); box-shadow:0 0 0 3px rgba(88,166,255,.15)}

  /* Two-panel layout */
  .panes{
    display:grid; grid-template-columns: 420px 1fr; gap:24px;
  }
  @media (max-width:1000px){ .panes{ grid-template-columns: 1fr; } }

  .panel{
    background:rgba(22,27,34,.95); border:1px solid var(--border); border-radius:16px;
    padding:20px; box-shadow:0 10px 30px rgba(0,0,0,.5);
    animation:fadeInUp .8s ease both;
  }
  .panel h2{
    margin:0 0 10px; font-size:1.1rem; color:var(--accent);
    letter-spacing:.2px;
  }

  textarea, input[type="text"]{
    width:100%; border-radius:12px; background:#0f141b; color:var(--text);
    border:1px solid var(--border); padding:12px 14px; font-size:14px;
  }
  .row{display:flex; gap:10px; align-items:center; flex-wrap:wrap}
  .btn{
    border:none; border-radius:12px; padding:10px 16px; font-weight:700; cursor:pointer;
    background:linear-gradient(135deg, var(--accent), var(--accent-2)); color:#fff;
    transition:transform .15s ease, box-shadow .3s ease, opacity .2s;
  }
  .btn:hover{ transform:translateY(-1px); box-shadow:0 8px 24px rgba(88,166,255,.35) }
  .btn.ghost{
    background:transparent; border:1px solid var(--border); color:var(--text);
  }
  .badge{
    display:inline-flex; align-items:center; gap:6px; padding:6px 10px; border-radius:999px;
    font-size:.8rem; border:1px dashed var(--border); color:var(--muted);
  }

  /* Context chunks */
  .chunks{ display:grid; gap:8px; margin-top:10px; }
  .chip{
    padding:10px 12px; border-radius:12px; background:#0f141b; border:1px solid var(--border);
    color:var(--muted); position:relative;
  }
  .chip .id{ font-weight:700; color:var(--accent); margin-right:6px }
  .chip.used{
    border-color:var(--accent); box-shadow:0 0 0 3px rgba(88,166,255,.15);
    animation:flash .9s ease;
  }

  /* Chat box */
  .chat{
    height:420px; overflow:auto; border:1px solid var(--border); border-radius:14px;
    background:#0f141b; padding:12px;
  }
  .msg{max-width:80%; padding:10px 12px; border-radius:12px; margin:8px 0; line-height:1.35}
  .user{ margin-left:auto; background: #1b2432; color:#dbe9ff; border:1px solid #223046 }
  .bot{ background:#0e1a22; border:1px solid #193042; color:#cfeaff }
  .cite{ display:block; margin-top:6px; font-size:.78rem; color:#9ac7ff }
  .dim{ color:var(--muted) }

  .controls{ margin-top:10px }

  /* Animations */
  .fade-in{ animation:fadeIn .7s ease both }
  .fade-in-up{ animation:fadeInUp .8s ease both }
  @keyframes fadeIn { from {opacity:0} to{opacity:1}}
  @keyframes fadeInUp { from {opacity:0; transform:translateY(12px)} to{opacity:1; transform:none} }
  @keyframes flash {
    0%{ box-shadow:0 0 0 0 rgba(88,166,255,.0) }
    40%{ box-shadow:0 0 0 6px rgba(88,166,255,.22) }
    100%{ box-shadow:0 0 0 3px rgba(88,166,255,.15) }
  }
</style>
</head>
<body>
<div id="particles-js"></div>

<div class="wrap">
  <h1 class="fade-in">Context-Aware QA Agent</h1>
  <div class="subtitle fade-in">
    A lightweight, in-browser demo of <strong>context engineering</strong>. Add background knowledge on the left.
    Ask questions on the right. The agent retrieves the most relevant snippets and composes an answer.
  </div>

  <!-- Step-by-step explainer (keeps updating as you interact) -->
  <div class="steps fade-in">
    <div class="step active" id="s1"><b>Step 1</b><br>Provide context (notes, FAQs, specs…)</div>
    <div class="step" id="s2"><b>Step 2</b><br>We split & index your context</div>
    <div class="step" id="s3"><b>Step 3</b><br>Ask a question — we retrieve</div>
    <div class="step" id="s4"><b>Step 4</b><br>Answer with cited snippets</div>
  </div>

  <div class="panes">
    <!-- LEFT: Context authoring -->
    <section class="panel fade-in-up">
      <h2>Custom Context</h2>
      <div class="badge">Tip: separate ideas with blank lines or bullets</div>
      <textarea id="contextInput" rows="10" placeholder="- Product: NovaPhone X\n- Battery: 4800 mAh, fast charge 45W\n- Warranty: 2 years parts & labor\n\nShipping in North America only.\nReturns within 30 days if unopened."></textarea>
      <div class="row" style="margin-top:10px">
        <button id="saveBtn" class="btn">Save & Index</button>
        <button id="clearBtn" class="btn ghost">Clear</button>
      </div>

      <h2 style="margin-top:16px">Parsed Knowledge</h2>
      <div id="chunks" class="chunks"></div>
    </section>

    <!-- RIGHT: Chat -->
    <section class="panel fade-in-up" style="animation-delay:.1s">
      <h2>Chat with the Agent</h2>
      <div class="chat" id="chat"></div>
      <div class="controls row">
        <input id="question" type="text" placeholder="Ask a question… e.g., 'How long is the warranty?'" />
        <button id="askBtn" class="btn">Ask</button>
        <button id="topkBtn" class="btn ghost" title="Toggle top-k evidence">Top-3</button>
      </div>
      <div class="row" style="margin-top:6px">
        <span class="badge">Mode: <strong>Extractive</strong> (answers quote your context)</span>
      </div>
    </section>
  </div>
</div>

<script>
  // ===== Particles (Cvless vibe) =====
  particlesJS("particles-js", {
    particles:{
      number:{value:80}, size:{value:3}, color:{value:"#58a6ff"},
      line_linked:{enable:true, distance:150, color:"#58a6ff", opacity:.35, width:1},
      move:{enable:true, speed:1.2}
    },
    interactivity:{ events:{ onhover:{ enable:true, mode:"repulse" } } }
  });

  // ===== Utility: simple tokenizer & stopwords =====
  const STOP = new Set(("a an and are as at be but by for from has have if in into is it its of on or than that the their there these this to was were will with your you").split(/\s+/));
  const tokenize = s => s
    .toLowerCase()
    .replace(/[^a-z0-9\s]+/g," ")
    .split(/\s+/)
    .filter(w => w && !STOP.has(w));

  // ===== Split context into chunks =====
  function splitContext(raw){
    // Prefer blank-line separated blocks; fallback to sentences
    const blocks = raw
      .split(/\n{2,}/)
      .map(b => b.trim())
      .filter(Boolean);

    if(blocks.length>0) return blocks;

    return raw
      .split(/(?<=[\.\?\!])\s+/)
      .map(s=>s.trim())
      .filter(Boolean);
  }

  // ===== TF-IDF Index =====
  function buildIndex(chunks){
    const docs = chunks.map((text, idx) => ({ id: idx, text, tokens: tokenize(text) }));
    const df = new Map(); // document frequency
    const vocab = new Map(); // term -> column index

    // DF & vocab
    docs.forEach(d=>{
      const seen = new Set(d.tokens);
      seen.forEach(t=>{
        df.set(t, (df.get(t)||0)+1);
        if(!vocab.has(t)) vocab.set(t, vocab.size);
      });
    });

    const N = docs.length || 1;
    const idf = new Float32Array(vocab.size);
    for(const [t, col] of vocab.entries()){
      const dfi = df.get(t) || 0;
      idf[col] = Math.log((N+1) / (dfi+1)) + 1; // smoothed IDF
    }

    // Build doc vectors (sparse as maps col->weight)
    const docVecs = docs.map(d=>{
      const tf = new Map();
      d.tokens.forEach(t=>{
        const col = vocab.get(t);
        tf.set(col, (tf.get(col)||0)+1);
      });
      // l2 normalize with idf
      let norm=0;
      for(const [col, f] of tf.entries()){
        const w = (f) * idf[col];
        tf.set(col, w);
        norm += w*w;
      }
      norm = Math.sqrt(norm)||1;
      for(const [col, w] of tf.entries()) tf.set(col, w/norm);
      return tf;
    });

    function vectorizeQuery(q){
      const toks = tokenize(q);
      const tf = new Map();
      toks.forEach(t=>{
        if(!vocab.has(t)) return;
        const col = vocab.get(t);
        tf.set(col, (tf.get(col)||0)+1);
      });
      let norm=0;
      for(const [col, f] of tf.entries()){
        const w = f * idf[col];
        tf.set(col, w);
        norm += w*w;
      }
      norm = Math.sqrt(norm)||1;
      for(const [col, w] of tf.entries()) tf.set(col, w/norm);
      return tf;
    }

    function cosine(a,b){
      // a and b are maps col->weight; iterate over smaller
      let dot=0;
      const [small, big] = (a.size < b.size) ? [a,b] : [b,a];
      for(const [col, wa] of small.entries()){
        const wb = big.get(col);
        if(wb) dot += wa*wb;
      }
      return dot;
    }

    function retrieve(q, k=3){
      const qv = vectorizeQuery(q);
      const scored = docVecs.map((dv, i)=>({ i, score: cosine(qv, dv) }));
      scored.sort((a,b)=>b.score-a.score);
      // adaptive threshold: keep those with score >= 0.35 of best, cap by k
      const best = scored[0]?.score || 0;
      const keep = scored.filter(s=>s.score >= best*0.35).slice(0,k);
      return keep.map(s=>({ idx:s.i, score:+s.score.toFixed(3), text:chunks[s.i] }));
    }

    return { docs, vocab, idf, docVecs, retrieve };
  }

  // ===== UI State =====
  const s1=document.getElementById('s1'), s2=document.getElementById('s2'),
        s3=document.getElementById('s3'), s4=document.getElementById('s4');

  const contextInput = document.getElementById('contextInput');
  const saveBtn = document.getElementById('saveBtn');
  const clearBtn = document.getElementById('clearBtn');
  const chunksEl = document.getElementById('chunks');

  const chat = document.getElementById('chat');
  const qInput = document.getElementById('question');
  const askBtn = document.getElementById('askBtn');
  const topkBtn = document.getElementById('topkBtn');

  let INDEX = null;
  let CHUNKS = [];
  let SHOW_TOP = 3;
  let lastLead = -1;

  function setSteps(activeIdx){
    [s1,s2,s3,s4].forEach((el,i)=>{ el.classList.toggle('active', i===activeIdx); });
  }

  function renderChunks(usedIdxs=[]){
    chunksEl.innerHTML = '';
    CHUNKS.forEach((text,i)=>{
      const div = document.createElement('div');
      div.className = 'chip';
      if(usedIdxs.includes(i)) div.classList.add('used');
      div.innerHTML = `<span class="id">#${i+1}</span>${escapeHtml(text)}`;
      chunksEl.appendChild(div);
    });
  }

  function escapeHtml(s){ return s.replace(/[&<>"]/g, c=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;' }[c])); }

  // Save & Index
  saveBtn.addEventListener('click', ()=>{
    const raw = contextInput.value.trim();
    if(!raw){ alert('Please add some context first.'); return; }
    setSteps(1);
    CHUNKS = splitContext(raw);
    INDEX = buildIndex(CHUNKS);
    renderChunks();
    setSteps(1); // still step 2 visually
    // small delay to emphasize transition
    setTimeout(()=>setSteps(1), 50);
    setSteps(1);
    // actually highlight Step 2
    s1.classList.remove('active');
    s2.classList.add('active');
  });

  clearBtn.addEventListener('click', ()=>{
    contextInput.value = '';
    CHUNKS = [];
    INDEX = null;
    chunksEl.innerHTML = '';
    addBot("Context cleared. Add new knowledge and click ‘Save & Index’.", "(system)");
    setSteps(0);
  });

  // Chat helpers
  function addUser(msg){
    const b = document.createElement('div');
    b.className = 'msg user fade-in';
    b.textContent = msg;
    chat.appendChild(b);
    chat.scrollTop = chat.scrollHeight;
  }
  function addBot(msg, citeHtml=''){
    const b = document.createElement('div');
    b.className = 'msg bot fade-in';
    b.innerHTML = msg + (citeHtml ? `<span class="cite">${citeHtml}</span>` : '');
    chat.appendChild(b);
    chat.scrollTop = chat.scrollHeight;
  }

  function leadIn(){
    const choices = [
      "From your context, I found:",
      "Here’s what your notes say:",
      "Most relevant to your question:",
      "According to the provided context:",
      "Pulling from the indexed snippets:"
    ];
    let pick;
    for(let tries=0; tries<4; tries++){
      const i = Math.floor(Math.random()*choices.length);
      if(i !== lastLead){ pick = i; break; }
    }
    lastLead = pick ?? 0;
    return choices[lastLead];
  }

  function composeAnswer(q, hits){
    if(hits.length===0){
      return {
        text: `I couldn’t find an answer in the current context. Please add the relevant info on the left and click <b>Save & Index</b>.`,
        cite: ''
      };
    }
    const lead = leadIn();
    // Build a concise extractive answer using the top one or two chunks
    const sentences = [];
    for (const h of hits.slice(0,2)) {
      // Prefer sentences from the chunk that share words with question
      const qs = new Set(tokenize(q));
      const ss = h.text.split(/(?<=[\.\!\?])\s+/).filter(Boolean);
      const scored = ss.map(s=>{
        const overlap = tokenize(s).filter(w=>qs.has(w)).length;
        return { s, overlap };
      }).sort((a,b)=>b.overlap-a.overlap);
      sentences.push(scored[0]?.s || ss[0]);
    }
    const answer = `${lead} ${escapeHtml(sentences.join(' '))}`;
    const cite = `evidence: ${hits.map(h=>`#${h.idx+1} (score ${h.score})`).join(' • ')}`;
    return { text: answer, cite };
  }

  // Ask action
  askBtn.addEventListener('click', ()=>{
    const q = qInput.value.trim();
    if(!q) return;
    addUser(q);
    if(!INDEX){
      addBot(`No context indexed yet. Add some notes on the left and click <b>Save & Index</b>.`);
      return;
    }
    setSteps(2);
    const hits = INDEX.retrieve(q, SHOW_TOP);
    // highlight used chunks
    renderChunks(hits.map(h=>h.idx));
    setSteps(3);
    const { text, cite } = composeAnswer(q, hits);
    addBot(text, cite);
    setSteps(3); // highlight step 4
    s3.classList.remove('active'); s4.classList.add('active');
    qInput.value='';
  });

  topkBtn.addEventListener('click', ()=>{
    SHOW_TOP = (SHOW_TOP===3) ? 1 : (SHOW_TOP===1 ? 5 : 3);
    topkBtn.textContent = `Top-${SHOW_TOP}`;
  });

  // Enter to send
  qInput.addEventListener('keydown', e=>{
    if(e.key==='Enter'){ e.preventDefault(); askBtn.click(); }
  });

  // Seed a small example so users see the flow (you can remove if you want)
  const seed = [
    "Product: NovaPhone X",
    "Battery: 4800 mAh; Fast charge: 45W; Wireless charge: 15W",
    "Warranty: 2 years parts & labor; Accidental damage not covered",
    "Shipping regions: North America only; Typical delivery 3–5 business days",
    "Returns accepted within 30 days if unopened; RMA required"
  ].join("\n");
  contextInput.value = seed;
</script>
</body>
</html>
