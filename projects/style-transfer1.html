<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Fast Style Transfer â€” CVless Theme</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<!-- CVless theme CSS -->
<link rel="stylesheet" href="/assets/css/main.css">

<style>
:root{
  --bg:#0d0d0d; --card:rgba(29,53,87,0.85); --accent:#4cc9f0; --muted:#bfc9d9;
}
html,body{height:100%;margin:0;background:var(--bg);color:#fff;font-family:'Inter',sans-serif;}
#particles-js{position:fixed;inset:0;z-index:-1;}
.wrap{min-height:100vh;display:flex;align-items:center;justify-content:center;padding:48px 20px;box-sizing:border-box;flex-direction:column;}
.card{width:100%;max-width:1200px;background:var(--card);border-radius:16px;padding:28px;box-shadow:0 12px 40px rgba(0,0,0,0.6);display:grid;gap:18px;grid-template-columns:1fr 1fr;align-items:start;}
.left,.right{display:flex;flex-direction:column;gap:12px;}
.preview{width:100%;height:360px;border-radius:12px;background:#111;display:flex;align-items:center;justify-content:center;overflow:hidden;box-shadow: inset 0 0 40px rgba(0,0,0,0.6);}
.preview img, .preview video{width:100%;height:100%;object-fit:cover;}
.controls{display:flex;gap:8px;flex-wrap:wrap;justify-content:center;}
.btn{background:linear-gradient(135deg,var(--accent),#4895ef);color:#0b1020;padding:10px 14px;border-radius:10px;font-weight:700;border:none;cursor:pointer;}
.btn.ghost{background:transparent;color:var(--accent);border:1px solid rgba(255,255,255,0.06);}
.btn.warn{background:#ef476f;color:#fff;}
h1{margin:0 0 6px;color:var(--accent);font-size:1.6rem;}
p.lead{margin:0 0 12px;color:var(--muted);}
.results{background:rgba(0,0,0,0.12);padding:12px;border-radius:10px;display:flex;flex-direction:column;gap:6px;}
.result-item{display:flex;justify-content:space-between;gap:12px;padding:6px 4px;align-items:center;border-bottom:1px dashed rgba(255,255,255,0.04);}
.result-item:last-child{border-bottom:none;}
.confidence{font-weight:700;color:#dff7ff;}
.status{margin-top:10px;color:var(--muted);font-size:0.95rem;}
.small{font-size:0.9rem;color:var(--muted);}
.image-grid{display:flex;flex-wrap:wrap;gap:10px;}
.image-grid img{width:80px;height:80px;object-fit:cover;border-radius:6px;cursor:pointer;transition:0.2s;}.image-grid img:hover{transform:scale(1.05);}
@media(max-width:980px){.card{grid-template-columns:1fr;}}
</style>

<!-- Particles.js -->
<script src="https://cdn.jsdelivr.net/npm/particles.js@2.0.0/particles.min.js"></script>

<!-- p5.js + ml5.js v0.11.1 -->
<script src="https://cdn.jsdelivr.net/npm/p5@1.6.0/lib/p5.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/ml5@0.11.1/dist/ml5.min.js"></script>
</head>

<body>
<div id="particles-js"></div>

<div class="wrap">
  <div class="card">
    <div class="left">
      <h1>Input Image / Webcam</h1>
      <div class="preview" id="preview">
        <div class="small" id="placeholder">No image uploaded</div>
      </div>
      <div class="controls">
        <input type="file" id="upload" accept="image/*" style="display:none">
        <button class="btn ghost" id="uploadBtn">Upload Image</button>
        <button class="btn ghost" id="webcamBtn">Use Webcam</button>
        <button class="btn ghost" id="captureBtn" disabled>Capture</button>
        <button class="btn" id="clearBtn">Clear</button>
      </div>
      <div class="status small" id="status">Status: Idle</div>
    </div>

    <div class="right">
      <h1>Style Transfer</h1>
      <div class="image-grid" id="styleGrid">
        <!-- Style images will be populated here -->
      </div>
      <button class="btn" id="transferBtn" disabled>Transfer Style</button>
      <div class="results" id="outputPreview">
        <div class="small">Result will appear here</div>
      </div>
    </div>
  </div>
</div>

<script>
// Initialize particles
particlesJS("particles-js",{particles:{number:{value:70},size:{value:3},move:{speed:1},line_linked:{enable:true,distance:150,color:"#4cc9f0"},color:{value:"#4cc9f0"}},interactivity:{events:{onhover:{enable:true,mode:"repulse"}}}});

// DOM elements
const preview = document.getElementById('preview');
const placeholder = document.getElementById('placeholder');
const upload = document.getElementById('upload');
const uploadBtn = document.getElementById('uploadBtn');
const webcamBtn = document.getElementById('webcamBtn');
const captureBtn = document.getElementById('captureBtn');
const clearBtn = document.getElementById('clearBtn');
const transferBtn = document.getElementById('transferBtn');
const styleGrid = document.getElementById('styleGrid');
const outputPreview = document.getElementById('outputPreview');
const statusEl = document.getElementById('status');

let currentImageEl = null;
let videoStream = null;
let styleTransfer = null;
let selectedStyleModel = "";

// Populate styles from /home/images/styles
const styleNames = ['starry-night','mosaic','scream','udnie']; // adjust with your actual style folders
styleNames.forEach(name=>{
  const img = document.createElement('img');
  img.src = `/home/images/${name}.jpg`;
  img.title = name;
  img.addEventListener('click', ()=>selectStyle(name,img));
  styleGrid.appendChild(img);
});

function selectStyle(name,imgEl){
  selectedStyleModel = `/home/models/${name}/`;
  Array.from(styleGrid.children).forEach(i=>i.style.border="");
  imgEl.style.border="2px solid var(--accent)";
  transferBtn.disabled = false;
}

// Upload image
uploadBtn.addEventListener('click', ()=>upload.click());
upload.addEventListener('change', e=>{
  const f = e.target.files[0];
  if(!f) return;
  stopWebcam();
  const img = document.createElement('img');
  img.src = URL.createObjectURL(f);
  img.onload = ()=>URL.revokeObjectURL(img.src);
  showPreview(img);
});

// Webcam
webcamBtn.addEventListener('click', async ()=>{
  if(videoStream){stopWebcam();return;}
  try{
    videoStream = await navigator.mediaDevices.getUserMedia({video:true,audio:false});
    const video = document.createElement('video');
    video.autoplay = true; video.muted=true; video.playsInline=true;
    video.srcObject = videoStream;
    await video.play();
    showPreview(video);
    captureBtn.disabled = false;
  } catch(err){console.error(err); alert('Could not access webcam.');}
});

captureBtn.addEventListener('click', ()=>{
  if(!currentImageEl || currentImageEl.tagName!=='VIDEO') return;
  const video=currentImageEl;
  const canvas=document.createElement('canvas');
  canvas.width=video.videoWidth; canvas.height=video.videoHeight;
  canvas.getContext('2d').drawImage(video,0,0,canvas.width,canvas.height);
  const img=document.createElement('img');
  img.src=canvas.toDataURL('image/jpeg');
  showPreview(img);
  stopWebcam();
});

clearBtn.addEventListener('click', ()=>{
  stopWebcam();
  preview.innerHTML='<div class="small" id="placeholder">No image uploaded</div>';
  currentImageEl=null;
  outputPreview.innerHTML='<div class="small">Result will appear here</div>';
  transferBtn.disabled = true;
  selectedStyleModel="";
  Array.from(styleGrid.children).forEach(i=>i.style.border="");
});

function showPreview(el){
  preview.innerHTML=''; preview.appendChild(el);
  currentImageEl = el;
}

// Stop webcam
function stopWebcam(){
  if(videoStream){videoStream.getTracks().forEach(t=>t.stop()); videoStream=null;}
}

// Transfer style
transferBtn.addEventListener('click', async ()=>{
  if(!currentImageEl){alert('Upload image or use webcam first'); return;}
  if(!selectedStyleModel){alert('Select a style'); return;}
  transferBtn.disabled=true;
  statusEl.textContent="Status: Loading model...";
  styleTransfer = ml5.styleTransfer(selectedStyleModel, ()=>runTransfer());
});

function runTransfer(){
  statusEl.textContent="Status: Processing...";
  styleTransfer.transfer(currentImageEl,(err,result)=>{
    if(err){console.error(err); statusEl.textContent="Status: Error"; transferBtn.disabled=false; return;}
    outputPreview.innerHTML='';
    const outImg=document.createElement('img');
    outImg.src=result.src; outImg.style.width='100%';
    outputPreview.appendChild(outImg);
    statusEl.textContent="Status: Done!";
    transferBtn.disabled=false;
  });
}
</script>
</body>
</html>
