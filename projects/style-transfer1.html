<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Style Transfer | My Portfolio</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<!-- CVless Theme CSS -->
<link rel="stylesheet" href="/home/assets/css/main.css">

<style>
  :root {
    --bg: #0d0d0d;
    --card: rgba(29,53,87,0.85);
    --accent: #4cc9f0;
    --muted: #bfc9d9;
  }
  html, body {
    margin:0;
    padding:0;
    height:100%;
    background: var(--bg);
    color: #fff;
    font-family: "Inter", sans-serif;
  }
  #particles-js { position:fixed; inset:0; z-index:-1; }
  .wrap {
    min-height:100vh;
    display:flex;
    align-items:flex-start;
    justify-content:center;
    gap:20px;
    padding:48px 20px;
  }
  .card {
    background: var(--card);
    border-radius:16px;
    padding:24px;
    box-shadow:0 12px 40px rgba(0,0,0,0.6);
    width:400px;
    display:flex;
    flex-direction:column;
    gap:18px;
  }
  h1 { color: var(--accent); margin:0; }
  .preview {
    width:100%;
    height:300px;
    background:#111;
    display:flex;
    justify-content:center;
    align-items:center;
    border-radius:12px;
    overflow:hidden;
    box-shadow: inset 0 0 40px rgba(0,0,0,0.6);
  }
  .preview img, .preview video { width:100%; height:100%; object-fit:cover; }
  .controls { display:flex; gap:8px; flex-wrap:wrap; justify-content:center; margin-top:10px; }
  .btn {
    background: linear-gradient(135deg,var(--accent),#4895ef);
    color:#0b1020;
    padding:10px 14px;
    border-radius:10px;
    font-weight:700;
    border:none;
    cursor:pointer;
  }
  .btn.ghost { background:transparent; color:var(--accent); border:1px solid rgba(255,255,255,0.06); }
  .results { background:rgba(0,0,0,0.12); padding:12px; border-radius:10px; margin-top:10px; min-height:80px; }
  .result-item { display:flex; justify-content:space-between; padding:6px; border-bottom:1px dashed rgba(255,255,255,0.04); }
  .result-item:last-child { border-bottom:none; }
</style>
</head>
<body>

<div id="particles-js"></div>

<div class="wrap">
  <div class="card" id="input-card">
    <h1>Input</h1>
    <div class="preview" id="preview">
      <div class="small">No image/video loaded</div>
    </div>
    <div class="controls">
      <label class="btn ghost">
        Upload Image<input type="file" id="input-upload" style="display:none" accept="image/*">
      </label>
      <button class="btn ghost" id="toggle-webcam">Use Webcam</button>
      <button class="btn" id="clear">Clear</button>
    </div>
    <div class="results" id="status">Status: Idle</div>
  </div>

  <div class="card" id="style-card">
    <h1>Style</h1>
    <div id="styles" style="display:flex; flex-wrap:wrap; gap:8px;"></div>
    <button class="btn" id="transfer-style">Transfer Style</button>
  </div>

  <div class="card" id="output-card">
    <h1>Output</h1>
    <div class="preview" id="output-preview"></div>
  </div>
</div>

<!-- Scripts -->
<script src="https://cdn.jsdelivr.net/npm/p5@1.6.0/lib/p5.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/ml5@0.11.1/dist/ml5.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/particles.js@2.0.0/particles.min.js"></script>

<script>
// Particles.js
particlesJS("particles-js", {
  particles: { number: { value: 70 }, size: { value: 3 }, move: { speed: 1 }, line_linked: { enable: true, distance: 140, color: "#4cc9f0" }, color: { value: "#4cc9f0" } },
  interactivity: { events: { onhover: { enable: true, mode: "repulse" } } }
});

// DOM refs
const preview = document.getElementById('preview');
const outputPreview = document.getElementById('output-preview');
const uploadInput = document.getElementById('input-upload');
const toggleWebcamBtn = document.getElementById('toggle-webcam');
const clearBtn = document.getElementById('clear');
const statusEl = document.getElementById('status');
const transferBtn = document.getElementById('transfer-style');
const stylesContainer = document.getElementById('styles');

let currentInputEl = null;
let videoStream = null;
let styleTransferModel = null;
let selectedStyle = null;

// Load style thumbnails dynamically
const styleImages = [
  { id:'starry-night', src:'/home/images/starry-night.jpg' },
  { id:'wave', src:'/home/images/wave.jpg' },
  { id:'udnie', src:'/home/images/udnie.jpg' }
];
styleImages.forEach(s=>{
  const img = document.createElement('img');
  img.src = s.src;
  img.style.width='80px';
  img.style.cursor='pointer';
  img.onclick = ()=> { selectedStyle=s.src; Array.from(stylesContainer.children).forEach(c=>c.style.border=''); img.style.border='2px solid var(--accent)'; };
  stylesContainer.appendChild(img);
});

// Input upload
uploadInput.addEventListener('change', e=>{
  const f = e.target.files[0];
  if (!f) return;
  stopWebcam();
  const img = document.createElement('img');
  img.src = URL.createObjectURL(f);
  img.onload = () => URL.revokeObjectURL(img.src);
  showInput(img);
});

// Webcam
toggleWebcamBtn.addEventListener('click', async ()=>{
  if(videoStream){ stopWebcam(); toggleWebcamBtn.textContent='Use Webcam'; return; }
  try{
    videoStream = await navigator.mediaDevices.getUserMedia({ video:true, audio:false });
    const video = document.createElement('video');
    video.autoplay = true;
    video.playsInline = true;
    video.srcObject = videoStream;
    await video.play();
    showInput(video);
    toggleWebcamBtn.textContent='Stop Webcam';
  }catch(e){
    alert('Cannot access webcam.');
  }
});

// Clear input
clearBtn.addEventListener('click', ()=>{
  stopWebcam();
  preview.innerHTML='<div class="small">No image/video loaded</div>';
  outputPreview.innerHTML='';
  currentInputEl=null;
  statusEl.textContent='Status: Idle';
});

// Show input in preview
function showInput(el){
  preview.innerHTML='';
  preview.appendChild(el);
  currentInputEl=el;
}

// Stop webcam
function stopWebcam(){
  if(videoStream){
    videoStream.getTracks().forEach(t=>t.stop());
    videoStream=null;
  }
}

// Load style transfer model
async function loadModel(){
  statusEl.textContent='Status: Loading model...';
  try{
    styleTransferModel = await ml5.styleTransfer('/home/models/style-model/', ()=>{
      statusEl.textContent='Status: Model loaded ✅';
    });
  }catch(e){
    statusEl.textContent='Status: Failed to load model';
    console.error(e);
  }
}
loadModel();

// Transfer style
transferBtn.addEventListener('click', async ()=>{
  if(!currentInputEl){ alert('Upload image or use webcam first'); return; }
  if(!selectedStyle){ alert('Select a style'); return; }
  if(!styleTransferModel){ alert('Model not loaded'); return; }

  statusEl.textContent='Status: Processing...';
  const inputEl = currentInputEl.tagName==='VIDEO'? captureVideoFrame(currentInputEl):currentInputEl;
  try{
    styleTransferModel.transfer(inputEl, selectedStyle, (err, result)=>{
      if(err){ console.error(err); statusEl.textContent='Error'; return; }
      const outImg = document.createElement('img');
      outImg.src=result.src;
      outImg.style.width='100%';
      outImg.style.height='100%';
      outImg.style.objectFit='cover';
      outputPreview.innerHTML='';
      outputPreview.appendChild(outImg);
      statusEl.textContent='Status: Done ✅';
    });
  }catch(e){
    console.error(e);
    statusEl.textContent='Error';
  }
});

// Capture video frame to canvas
function captureVideoFrame(video){
  const canvas = document.createElement('canvas');
  canvas.width=video.videoWidth;
  canvas.height=video.videoHeight;
  const ctx = canvas.getContext('2d');
  ctx.drawImage(video,0,0,canvas.width,canvas.height);
  const img = document.createElement('img');
  img.src = canvas.toDataURL('image/jpeg');
  return img;
}
</script>

</body>
</html>
